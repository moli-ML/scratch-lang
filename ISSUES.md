# ScratchLang 问题清单

> 代码审查日期: 2025-12-13
> 最后更新: 2025-12-13

---

## 一、工程化问题

### 1.1 缺少版本控制
- [x] ~~项目没有初始化 Git 仓库~~ (已完成 `git init`)
- [x] ~~没有 `.gitignore` 文件~~ (已添加)
- [x] ~~`__pycache__` 目录和 `.pyc` 文件应被忽略~~ (已在 .gitignore 中配置)

### 1.2 缺少测试
- [x] ~~没有任何单元测试~~ (已添加 tests/ 目录)
- [x] ~~`parser.py` 有 900+ 行代码，0 个测试覆盖~~ (已添加 test_parser.py)
- [x] ~~正则表达式匹配逻辑没有测试验证~~ (已添加 test_blocks.py)
- [x] ~~建议添加 `tests/` 目录，使用 pytest~~ (已完成)

### 1.3 缺少 LICENSE 文件
- [x] ~~README 声称 MIT 许可证，但没有 LICENSE 文件~~ (已添加 MIT LICENSE)

### 1.4 依赖不完整
- [x] ~~`requirements.txt` 只有 PyQt5~~ (已添加 Pillow)
- [x] ~~缺少 Pillow（图片处理可能需要）~~ (已添加)
- [x] ~~建议添加 `requirements-dev.txt`（开发依赖）~~ (已添加)

---

## 二、代码质量问题

### 2.1 缺少类型注解
- [x] ~~所有 `.py` 文件都没有类型注解~~ (已为核心模块添加)
- [x] ~~函数参数和返回值类型不明确~~ (已添加类型注解)
- [x] ~~建议使用 `typing` 模块添加类型提示~~ (已完成)

### 2.2 正则表达式可维护性差
- [ ] `blocks.py` 中大量复杂正则，缺少注释说明
- [ ] 建议使用 `re.VERBOSE` 模式增加可读性

### 2.3 错误处理不规范
- [ ] 大量使用 `print()` 输出警告，用户在 IDE 中看不到
- [x] ~~缺少自定义异常类~~ (已添加 `compiler/exceptions.py`)
- [x] ~~创建 `ScratchLangError` 基类~~ (已完成)
- [x] ~~创建 `ParseError`、`CompileError` 等子类~~ (已完成)
- [ ] 错误信息应显示在 IDE 输出窗口

### 2.4 魔法字符串过多
- [x] ~~特殊值如 `"_mouse_"`、`"_random_"` 散落各处~~ (已提取到 `compiler/constants.py`)
- [x] ~~建议提取为常量或枚举类~~ (已完成)

### 2.5 代码重复
- [x] ~~`_split_by_plus()` 和 `_split_by_comma()` 逻辑几乎相同~~ (已重构)
- [x] ~~可以抽象为通用的 `_split_by_delimiter()` 方法~~ (已完成)

---

## 三、IDE 功能缺失

### 3.1 编辑器功能
- [x] ~~没有行号显示~~ (已有，代码中已实现 LineNumberArea)
- [x] ~~没有自动补全~~ (已添加关键字自动补全)
- [x] ~~没有括号匹配~~ (已添加括号高亮)
- [x] ~~没有代码折叠~~ (已添加，支持重复/如果/重复执行结构折叠)
- [x] ~~没有查找/替换功能（Ctrl+F）~~ (已添加 Ctrl+F 查找和 Ctrl+H 替换)

### 3.2 错误提示
- [x] ~~编译错误没有定位到具体行号~~ (已添加行号显示)
- [x] ~~没有实时语法检查~~ (已添加，500ms 延迟检查)
- [x] ~~错误信息不够友好~~ (已改进，显示在输出窗口)

### 3.3 用户体验
- [x] ~~没有最近打开文件列表~~ (已添加)
- [x] ~~没有自动保存功能~~ (已添加，每60秒自动保存)
- [x] ~~没有主题切换（深色/浅色）~~ (已添加，视图菜单中可切换)

---

## 四、功能完整性问题

### 4.1 积木支持不完整
- [ ] 缺少自定义积木（自制积木）支持
- [ ] 缺少扩展积木支持（音乐、视频侦测等）
- [ ] 缺少云变量支持

### 4.2 资源处理
- [x] ~~没有验证图片/音频文件格式~~ (已添加文件头魔数验证)
- [x] ~~没有处理文件不存在的情况（只打印警告）~~ (已改为抛出异常)
- [ ] SVG 文件的 rotationCenter 计算可能不准确

### 4.3 语法限制
- [ ] 不支持多行字符串
- [ ] 不支持转义字符
- [ ] 注释只支持 `//`，不支持 `/* */`

---

## 五、文档问题

### 5.1 代码注释
- [x] ~~核心函数缺少 docstring~~ (已为核心模块添加)
- [ ] 复杂逻辑缺少行内注释
- [ ] `AGENTS.md` 内容不明确

### 5.2 用户文档
- [x] ~~缺少完整的语法参考手册~~ (已添加 docs/SYNTAX.md)
- [ ] 缺少错误代码对照表
- [x] ~~缺少更多示例项目~~ (已添加 examples/demo.sl)

---

## 六、安全问题

### 6.1 路径处理
- [x] ~~`resolve_path()` 没有防止路径遍历攻击~~ (已添加安全检查)
- [x] ~~用户可能通过 `../../../` 访问敏感文件~~ (已修复，会抛出 SecurityError)

### 6.2 文件操作
- [x] ~~没有限制可导入文件的大小~~ (已添加：图片10MB，音效20MB)
- [ ] 没有验证文件内容是否为有效的图片/音频

---

## 七、Bug 修复

### 7.1 已修复的 Bug
- [x] ~~比较运算符 `>=` 和 `<=` 处理错误~~ (已修复，使用 not 组合实现)
- [x] ~~空的 except 块~~ (已改为 except ValueError)
- [x] ~~如果/否则积木定义冲突~~ (已修复)
- [x] ~~临时文件使用硬编码路径~~ (已改用 tempfile 模块)
- [x] ~~已弃用的 QFontMetrics.width() API~~ (已改用 horizontalAdvance())

---

## 完成统计

| 类别 | 总数 | 已完成 | 完成率 |
|------|------|--------|--------|
| 工程化问题 | 10 | 10 | 100% |
| 代码质量问题 | 11 | 9 | 82% |
| IDE 功能缺失 | 11 | 11 | 100% |
| 功能完整性问题 | 9 | 2 | 22% |
| 文档问题 | 6 | 3 | 50% |
| 安全问题 | 4 | 4 | 100% |
| Bug 修复 | 5 | 5 | 100% |
| **总计** | **56** | **44** | **79%** |

---

## 优先级建议

| 优先级 | 功能 | 状态 |
|--------|------|------|
| 1 | 文件大小限制 | ✅ 已完成 |
| 2 | 自动补全 | ✅ 已完成 |
| 3 | 实时语法检查 | ✅ 已完成 |
| 4 | 主题切换 | ✅ 已完成 |
| 5 | 代码折叠 | ✅ 已完成 |
| 6 | 文件格式验证 | ✅ 已完成 |
| 7 | 自定义积木支持 | ⏳ 待完成 |

---

## 新增文件清单

本次修复新增的文件：

```
scratch-lang/
├── .gitignore                    # Git 忽略规则
├── LICENSE                       # MIT 许可证
├── requirements-dev.txt          # 开发依赖
├── compiler/
│   ├── exceptions.py             # 自定义异常类
│   └── constants.py              # 常量定义（魔法字符串提取）
├── tests/
│   ├── __init__.py
│   ├── test_parser.py            # 解析器测试
│   ├── test_blocks.py            # 积木定义测试
│   ├── test_builder.py           # 构建器测试
│   └── test_exceptions.py        # 异常类测试
├── docs/
│   └── SYNTAX.md                 # 语法参考手册
└── examples/
    └── demo.sl                   # 示例代码
```

---

## 修改的文件清单

本次修复修改的文件：

| 文件 | 修改内容 |
|------|----------|
| `compiler/parser.py` | 修复 >= <= 运算符、空 except、路径安全、重构重复代码、使用常量 |
| `compiler/blocks.py` | 删除重复的如果否则定义、添加类型注解 |
| `compiler/builder.py` | 添加类型注解和 docstring |
| `compiler/assets.py` | 添加文件大小限制、文件格式验证、类型注解 |
| `ide/mainwindow.py` | 添加查找替换、最近文件、自动保存、主题切换、语法错误显示 |
| `ide/editor.py` | 修复弃用 API、添加自动补全、实时语法检查、代码折叠、类型注解 |
| `ide/highlighter.py` | 添加括号高亮、变量高亮、类型注解 |
| `requirements.txt` | 添加开发依赖注释 |

---

*此清单由代码审查生成，建议按优先级逐步修复。*

*最后更新: 2025-12-13*
